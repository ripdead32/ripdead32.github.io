<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Rip_Dead Site - Register</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body {margin:0;padding:0;background:black;color:#00ff00;font-family:"Courier New", monospace;text-align:center;}
h1 {font-size:2.5em;margin-top:60px;text-shadow:0 0 10px #00ff00;}
form {margin-top:40px;}
input {margin:10px;padding:10px;border:2px solid #00ff00;border-radius:6px;background:black;color:#00ff00;font-family:"Courier New", monospace;}
button {padding:10px 20px;border:2px solid #00ff00;border-radius:6px;background:black;color:#00ff00;font-weight:bold;cursor:pointer;}
button:hover {transform: scale(1.1);box-shadow:0 0 10px #00ff00;}
#error {color:red;margin-top:10px;}
</style>
</head>
<body>

<h1>Register</h1>

<form id="register-form">
<input type="text" id="username" placeholder="Username" required><br>
<input type="email" id="email" placeholder="Email" required><br>
<input type="password" id="password" placeholder="Password" required><br>
<button type="submit">Register</button>
</form>

<div id="error"></div>

<script>
const supabaseUrl = 'https://uuvddjdbflwtbrbcgttj.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1dmRkamRiZmx3dGJyYmNndHRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MTAzNTIsImV4cCI6MjA4NzE4NjM1Mn0.b_betmbrXem0_EwtXCoXRLU7E2w2KEKJKVncQ9f0dVE';
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

const form = document.getElementById('register-form');
const errorDiv = document.getElementById('error');

form.addEventListener('submit', async (e) => {
    e.preventDefault();
    errorDiv.textContent = '';

    const username = document.getElementById('username').value.trim();
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;

    // 1️⃣ Check if email already exists
    const { data: existingUser, error: selectError } = await supabase
        .from('users')
        .select('id')
        .eq('email', email)
        .limit(1)
        .maybeSingle();

    if (existingUser) {
        errorDiv.textContent = 'This account is registered already';
        return;
    }

    // 2️⃣ Create user in Supabase Auth
    const { data, error } = await supabase.auth.signUp({
        email,
        password,
        options: {
            data: { username } // store username in user_metadata
        }
    });

    if (error) {
        errorDiv.textContent = error.message;
        return;
    }

    // 3️⃣ Insert into users table for RLS policies
    const { error: insertError } = await supabase.from('users').insert([
        { id: data.user.id, email, username, bio: '', profile_pic: null }
    ]);

    if (insertError) {
        errorDiv.textContent = insertError.message;
        return;
    }

    // 4️⃣ Success — redirect to home
    window.location = '/';
});
</script>

</body>
</html>
