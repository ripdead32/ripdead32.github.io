<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Rip_Dead Site - User Profile</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body {margin:0;padding:0;background:black;color:#00ff00;font-family:"Courier New", monospace;text-align:center;}
h1 {font-size:2.5em;margin-top:60px;text-shadow:0 0 10px #00ff00;}
input, textarea {margin:10px;padding:10px;width:300px;border:2px solid #00ff00;border-radius:6px;background:black;color:#00ff00;font-family:"Courier New", monospace;}
button {padding:6px 14px;margin:5px;border:2px solid #00ff00;border-radius:6px;background:black;color:#00ff00;font-weight:bold;cursor:pointer;}
button:hover {transform:scale(1.1);box-shadow:0 0 10px #00ff00;}
img.profile-pic {width:150px;height:150px;border:2px solid #00ff00;border-radius:50%;background:transparent;display:block;margin:20px auto;}
#error {color:red;margin-top:10px;}
.success {color:#00ff00;margin-top:10px;}
</style>
</head>
<body>

<h1 id="username-header">User Profile</h1>
<img id="profile-pic" class="profile-pic" src="" alt="Profile Picture">

<div id="bio-section">
<h3>Bio:</h3>
<p id="bio-display"></p>
<textarea id="bio-edit" style="display:none;"></textarea><br>
<button id="bio-save" style="display:none;">Save Bio</button>
</div>

<div id="pic-section">
<input type="file" id="pic-input" style="display:none;">
<button id="pic-save" style="display:none;">Update Profile Picture</button>
</div>

<div id="messages"></div>

<script>
const supabaseUrl = 'https://uuvddjdbflwtbrbcgttj.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1dmRkamRiZmx3dGJyYmNndHRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MTAzNTIsImV4cCI6MjA4NzE4NjM1Mn0.b_betmbrXem0_EwtXCoXRLU7E2w2KEKJKVncQ9f0dVE';
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

const usernameHeader = document.getElementById('username-header');
const bioDisplay = document.getElementById('bio-display');
const bioEdit = document.getElementById('bio-edit');
const bioSaveBtn = document.getElementById('bio-save');
const picInput = document.getElementById('pic-input');
const picSaveBtn = document.getElementById('pic-save');
const profilePic = document.getElementById('profile-pic');
const messagesDiv = document.getElementById('messages');

// Get username from URL
const pathParts = window.location.pathname.split('/');
const pageUsername = pathParts[2]; // /users/[username]/

let currentUser = null;

async function loadUser() {
    const { data: userData } = await supabase.auth.getUser();
    if (userData && userData.user) currentUser = userData.user;

    usernameHeader.textContent = pageUsername;

    // Fetch user profile info from table
    const { data, error } = await supabase
        .from('users')
        .select('*')
        .eq('username', pageUsername)
        .maybeSingle();

    if (error || !data) {
        messagesDiv.textContent = 'User not found';
        return;
    }

    bioDisplay.textContent = data.bio || '';
    profilePic.src = data.profile_pic || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='; // Transparent if none

    // If current user owns this page, allow edits
    if (currentUser && currentUser.user_metadata.username === pageUsername) {
        bioDisplay.style.display = 'none';
        bioEdit.style.display = 'block';
        bioEdit.value = data.bio || '';
        bioSaveBtn.style.display = 'inline-block';
        picInput.style.display = 'block';
        picSaveBtn.style.display = 'inline-block';
    }
}

bioSaveBtn.addEventListener('click', async () => {
    const newBio = bioEdit.value.trim();
    const { error } = await supabase
        .from('users')
        .update({ bio: newBio })
        .eq('username', pageUsername);

    if (error) {
        messagesDiv.textContent = 'Failed to update bio';
    } else {
        messagesDiv.textContent = 'Bio updated!';
        bioDisplay.textContent = newBio;
    }
});

picSaveBtn.addEventListener('click', async () => {
    const file = picInput.files[0];
    if (!file) {
        messagesDiv.textContent = 'Please select a file';
        return;
    }

    const fileExt = file.name.split('.').pop();
    const fileName = `${pageUsername}.${fileExt}`;
    const filePath = `profile-pics/${fileName}`;

    const { error: uploadError } = await supabase.storage
        .from('avatars')
        .upload(filePath, file, { upsert: true });

    if (uploadError) {
        messagesDiv.textContent = 'Failed to upload image';
        return;
    }

    const { data: urlData } = supabase.storage.from('avatars').getPublicUrl(filePath);
    const { error: updateError } = await supabase
        .from('users')
        .update({ profile_pic: urlData.publicUrl })
        .eq('username', pageUsername);

    if (updateError) {
        messagesDiv.textContent = 'Failed to update profile picture';
    } else {
        profilePic.src = urlData.publicUrl;
        messagesDiv.textContent = 'Profile picture updated!';
    }
});

loadUser();
</script>

</body>
</html>
